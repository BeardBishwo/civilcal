<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Detection Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .address-input { display: flex; gap: 10px; align-items: flex-start; }
        input { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .btn-detect-location { 
            background: #4f46e5; 
            color: white; 
            padding: 12px 16px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-detect-location:hover { background: #3730a3; }
        .btn-detect-location:disabled { background: #9ca3af; cursor: not-allowed; }
        .location-message { margin-top: 10px; }
        .info-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .test-results { margin-top: 30px; padding: 20px; background: #f0f9ff; border-radius: 8px; }
    </style>
</head>
<body>
    <h2>üìç Location Detection Test</h2>
    
    <div class="info-box">
        <h3>üß™ Test Instructions:</h3>
        <ol>
            <li><strong>Click "Detect My Location"</strong> button below</li>
            <li><strong>Confirm permission</strong> when browser asks</li>
            <li><strong>Allow location access</strong> when prompted</li>
            <li><strong>Address should auto-fill</strong> with your location</li>
        </ol>
        
        <p><strong>Note:</strong> This test uses the same location detection code as the registration form.</p>
    </div>
    
    <div class="form-group">
        <label for="address">Address:</label>
        <div class="address-input">
            <input type="text" id="address" name="address" placeholder="Enter your address or click detect">
            <button type="button" class="btn-detect-location" id="detectLocation">
                <i class="fas fa-location-dot"></i> Detect My Location
            </button>
        </div>
    </div>
    
    <div class="test-results">
        <h3>üìä Test Results:</h3>
        <div id="testResults">
            <p>Click the "Detect My Location" button to start the test.</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
        // Location detection functionality (same as registration form)
        document.getElementById('detectLocation').addEventListener('click', function() {
            detectUserLocation();
        });

        async function detectUserLocation() {
            const detectBtn = document.getElementById('detectLocation');
            const originalText = detectBtn.innerHTML;
            const addressInput = document.getElementById('address');
            const resultsDiv = document.getElementById('testResults');
            
            detectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting...';
            detectBtn.disabled = true;
            
            resultsDiv.innerHTML = '<p>üîÑ Starting location detection...</p>';
            
            try {
                console.log('üìç Manual location detection requested...');
                resultsDiv.innerHTML += '<p>‚úÖ Location detection function called</p>';
                
                // Check if geolocation is supported
                if (!navigator.geolocation) {
                    throw new Error('Geolocation is not supported by this browser');
                }
                
                resultsDiv.innerHTML += '<p>‚úÖ Geolocation API is supported</p>';
                
                // Ask user for permission with better messaging
                const userConfirmed = confirm(
                    'üó∫Ô∏è Location Access Request\n\n' +
                    'This will ask for your location permission to automatically fill your address.\n\n' +
                    '‚úÖ Click "OK" to allow location access\n' +
                    '‚ùå Click "Cancel" to skip automatic detection\n\n' +
                    'Your location data is only used to fill the address field and is not stored.'
                );
                
                if (userConfirmed) {
                    resultsDiv.innerHTML += '<p>‚úÖ User confirmed location access</p>';
                    detectBtn.innerHTML = '<i class="fas fa-location-dot fa-pulse"></i> Requesting permission...';
                    
                    // Request GPS position with better options
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                console.log('üìç GPS position obtained:', pos.coords);
                                resolve(pos);
                            },
                            (error) => {
                                console.warn('‚ùå GPS error:', error.message);
                                let errorMsg = 'Location access denied or failed.';
                                
                                switch(error.code) {
                                    case error.PERMISSION_DENIED:
                                        errorMsg = 'Location access was denied. Please enable location permissions in your browser settings.';
                                        break;
                                    case error.POSITION_UNAVAILABLE:
                                        errorMsg = 'Location information is unavailable.';
                                        break;
                                    case error.TIMEOUT:
                                        errorMsg = 'Location request timed out.';
                                        break;
                                }
                                
                                reject(new Error(errorMsg));
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 15000,
                                maximumAge: 60000 // 1 minute
                            }
                        );
                    });
                    
                    if (position) {
                        resultsDiv.innerHTML += `<p>‚úÖ GPS position obtained: ${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}</p>`;
                        detectBtn.innerHTML = '<i class="fas fa-map"></i> Getting address...';
                        
                        // Use a free geocoding service or create a simple address
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Try to get address using a free service
                        try {
                            const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
                            
                            if (geocodeResponse.ok) {
                                const geocodeData = await geocodeResponse.json();
                                
                                if (geocodeData && geocodeData.display_name) {
                                    addressInput.value = geocodeData.display_name;
                                    resultsDiv.innerHTML += '<p>‚úÖ Address successfully retrieved from coordinates</p>';
                                    
                                    // Show success message
                                    showLocationSuccess('Location detected successfully!');
                                } else {
                                    throw new Error('No address found');
                                }
                            } else {
                                throw new Error('Geocoding service unavailable');
                            }
                        } catch (geocodeError) {
                            // Fallback: show coordinates
                            addressInput.value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                            resultsDiv.innerHTML += '<p>‚ö†Ô∏è Address lookup failed, showing coordinates instead</p>';
                            showLocationSuccess('Location coordinates detected! You can edit the address manually.');
                        }
                    }
                } else {
                    // User cancelled - show helpful message
                    resultsDiv.innerHTML += '<p>‚ÑπÔ∏è User cancelled location detection</p>';
                    showLocationInfo('Location detection cancelled. You can enter your address manually.');
                }
                
            } catch (error) {
                console.error('‚ùå Location detection error:', error);
                resultsDiv.innerHTML += `<p>‚ùå Error: ${error.message}</p>`;
                showLocationError(error.message || 'Location detection failed. Please enter your address manually.');
            } finally {
                detectBtn.innerHTML = originalText;
                detectBtn.disabled = false;
                resultsDiv.innerHTML += '<p>üèÅ Location detection process completed</p>';
            }
        }

        // Helper functions for showing messages
        function showLocationSuccess(message) {
            showLocationMessage(message, 'success');
        }

        function showLocationError(message) {
            showLocationMessage(message, 'error');
        }

        function showLocationInfo(message) {
            showLocationMessage(message, 'info');
        }

        function showLocationMessage(message, type) {
            // Remove any existing message
            const existingMessage = document.querySelector('.location-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create new message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `location-message location-${type}`;
            
            let icon = 'fas fa-info-circle';
            let color = '#3b82f6';
            
            if (type === 'success') {
                icon = 'fas fa-check-circle';
                color = '#10b981';
            } else if (type === 'error') {
                icon = 'fas fa-exclamation-triangle';
                color = '#ef4444';
            }
            
            messageDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; padding: 12px; border-radius: 8px; background: rgba(${type === 'success' ? '16,185,129' : type === 'error' ? '239,68,68' : '59,130,246'},0.1); border: 1px solid rgba(${type === 'success' ? '16,185,129' : type === 'error' ? '239,68,68' : '59,130,246'},0.3); color: ${color}; font-size: 14px; margin-top: 8px;">
                    <i class="${icon}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Insert after the address input
            const addressInput = document.getElementById('address');
            if (addressInput && addressInput.parentNode) {
                addressInput.parentNode.insertBefore(messageDiv, addressInput.nextSibling);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (messageDiv && messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
        }
    </script>
</body>
</html>
