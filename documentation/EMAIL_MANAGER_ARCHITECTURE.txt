================================================================================
EMAIL MANAGER SYSTEM - ARCHITECTURE DIAGRAM
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                          ADMIN PANEL - EMAIL MANAGER                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                              FRONTEND LAYER                                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌─────────────────┐  ┌──────────────────┐  ┌──────────────────┐            │
│  │   Dashboard     │  │   Threads List   │  │  Thread Detail   │            │
│  │                 │  │                  │  │                  │            │
│  │ • Statistics    │  │ • Filters        │  │ • Full Thread    │            │
│  │ • Recent        │  │ • Search         │  │ • Responses      │            │
│  │   Threads       │  │ • Pagination     │  │ • Reply Form     │            │
│  │ • Quick Links   │  │ • Bulk Actions   │  │ • Actions Panel  │            │
│  └─────────────────┘  └──────────────────┘  └──────────────────┘            │
│                                                                               │
│  ┌─────────────────┐  ┌──────────────────┐  ┌──────────────────┐            │
│  │   Templates     │  │  Template Form   │  │    Settings      │            │
│  │                 │  │                  │  │                  │            │
│  │ • List          │  │ • Create         │  │ • SMTP Config    │            │
│  │ • Edit          │  │ • Edit           │  │ • Email Settings │            │
│  │ • Delete        │  │ • Variables      │  │ • Test Email     │            │
│  │ • Use           │  │ • Preview        │  │ • Encryption     │            │
│  └─────────────────┘  └──────────────────┘  └──────────────────┘            │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
                                    ↓ (HTTP Requests)
┌──────────────────────────────────────────────────────────────────────────────┐
│                            ROUTING LAYER                                     │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  /admin/email-manager              → EmailManagerController@dashboard        │
│  /admin/email-manager/stats        → EmailManagerController@stats            │
│  /admin/email-manager/threads      → EmailManagerController@threads          │
│  /admin/email-manager/thread/{id}  → EmailManagerController@viewThread       │
│  /admin/email-manager/thread/{id}/reply     → EmailManagerController@reply   │
│  /admin/email-manager/thread/{id}/status    → EmailManagerController@status  │
│  /admin/email-manager/thread/{id}/assign    → EmailManagerController@assign  │
│  /admin/email-manager/thread/{id}/priority  → EmailManagerController@priority│
│  /admin/email-manager/templates    → EmailManagerController@templates        │
│  /admin/email-manager/template/{id}→ EmailManagerController@editTemplate     │
│  /admin/email-manager/settings     → EmailManagerController@settings         │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
                                    ↓ (Route Dispatch)
┌──────────────────────────────────────────────────────────────────────────────┐
│                         CONTROLLER LAYER                                     │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │         EmailManagerController (622 lines)                          │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │                                                                      │   │
│  │  Dashboard Methods:                                                 │   │
│  │  • dashboard()         - Load dashboard view                        │   │
│  │  • stats()             - Return statistics JSON                     │   │
│  │                                                                      │   │
│  │  Thread Methods:                                                    │   │
│  │  • threads()           - List threads with filters                  │   │
│  │  • viewThread($id)     - View single thread                         │   │
│  │  • reply($id)          - Add reply to thread                        │   │
│  │  • updateStatus($id)   - Update thread status                       │   │
│  │  • assign($id)         - Assign thread to admin                     │   │
│  │  • updatePriority($id) - Update thread priority                     │   │
│  │                                                                      │   │
│  │  Template Methods:                                                  │   │
│  │  • templates()         - List templates                             │   │
│  │  • createTemplate()    - Create new template                        │   │
│  │  • editTemplate($id)   - Edit template                              │   │
│  │  • updateTemplate($id) - Update template                            │   │
│  │  • deleteTemplate($id) - Delete template                            │   │
│  │  • useTemplate($id)    - Get template for use                       │   │
│  │                                                                      │   │
│  │  Settings Methods:                                                  │   │
│  │  • settings()          - Show settings page                         │   │
│  │  • updateSettings()    - Update SMTP settings                       │   │
│  │  • testEmail()         - Send test email                            │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
                                    ↓ (Data Operations)
┌──────────────────────────────────────────────────────────────────────────────┐
│                          SERVICE LAYER                                       │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────────┐  ┌────────────────────────────────────────┐   │
│  │   EmailManager Service   │  │    EmailService                        │   │
│  │   (455 lines)            │  │                                        │   │
│  ├──────────────────────────┤  ├────────────────────────────────────────┤   │
│  │                          │  │                                        │   │
│  │ • loadSettings()         │  │ • sendEmail()                          │   │
│  │ • initializeMailer()     │  │ • sendVerificationEmail()              │   │
│  │ • sendEmail()            │  │ • sendPasswordResetEmail()             │   │
│  │ • sendViaPHPMailer()     │  │ • sendWelcomeEmail()                   │   │
│  │ • sendViaPHPMail()       │  │ • getTemplate()                        │   │
│  │ • getTemplate()          │  │ • testEmailSettings()                  │   │
│  │ • testEmailSettings()    │  │                                        │   │
│  │ • getSettings()          │  │                                        │   │
│  │ • updateSettings()       │  │                                        │   │
│  │                          │  │                                        │   │
│  └──────────────────────────┘  └────────────────────────────────────────┘   │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
                                    ↓ (Data Access)
┌──────────────────────────────────────────────────────────────────────────────┐
│                           MODEL LAYER                                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────┐   │
│  │   EmailThread        │  │  EmailTemplate       │  │ EmailResponse    │   │
│  │   (346 lines)        │  │                      │  │                  │   │
│  ├──────────────────────┤  ├──────────────────────┤  ├──────────────────┤   │
│  │                      │  │                      │  │                  │   │
│  │ • find()             │  │ • getAll()           │  │ • find()         │   │
│  │ • create()           │  │ • getById()          │  │ • create()       │   │
│  │ • getAll()           │  │ • create()           │  │ • update()       │   │
│  │ • getUnassigned()    │  │ • update()           │  │ • delete()       │   │
│  │ • update()           │  │ • delete()           │  │ • getByThread()  │   │
│  │ • addResponse()      │  │ • validate()         │  │                  │   │
│  │ • getWithResponses() │  │ • getStats()         │  │                  │   │
│  │ • getStatistics()    │  │ • getActiveTemplates│  │                  │   │
│  │ • markAsResolved()   │  │ • getTemplateTypes() │  │                  │   │
│  │ • reopen()           │  │                      │  │                  │   │
│  │ • getRecentThreads() │  │                      │  │                  │   │
│  │ • getThreadsWithFilters() │                    │  │                  │   │
│  │ • getAvailableAssignees() │                    │  │                  │   │
│  │                      │  │                      │  │                  │   │
│  └──────────────────────┘  └──────────────────────┘  └──────────────────┘   │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
                                    ↓ (SQL Queries)
┌──────────────────────────────────────────────────────────────────────────────┐
│                         DATABASE LAYER                                       │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────┐   │
│  │  email_threads       │  │  email_responses     │  │ email_templates  │   │
│  ├──────────────────────┤  ├──────────────────────┤  ├──────────────────┤   │
│  │                      │  │                      │  │                  │   │
│  │ id (PK)              │  │ id (PK)              │  │ id (PK)          │   │
│  │ user_id (FK)         │  │ thread_id (FK)       │  │ name             │   │
│  │ from_email           │  │ user_id (FK)         │  │ subject          │   │
│  │ from_name            │  │ message              │  │ content          │   │
│  │ subject              │  │ is_internal_note     │  │ category         │   │
│  │ message              │  │ created_at           │  │ description      │   │
│  │ category             │  │ updated_at           │  │ variables (JSON) │   │
│  │ priority             │  │                      │  │ is_active        │   │
│  │ status               │  │ Indexes:             │  │ created_by (FK)  │   │
│  │ assigned_to (FK)     │  │ • thread_id          │  │ created_at       │   │
│  │ response_count       │  │ • user_id            │  │ updated_at       │   │
│  │ last_response_at     │  │                      │  │                  │   │
│  │ created_at           │  │                      │  │ Indexes:         │   │
│  │ updated_at           │  │                      │  │ • category       │   │
│  │                      │  │                      │  │ • is_active      │   │
│  │ Indexes:             │  │                      │  │                  │   │
│  │ • status             │  │                      │  │                  │   │
│  │ • priority           │  │                      │  │                  │   │
│  │ • assigned_to        │  │                      │  │                  │   │
│  │ • created_at         │  │                      │  │                  │   │
│  │                      │  │                      │  │                  │   │
│  └──────────────────────┘  └──────────────────────┘  └──────────────────┘   │
│                                                                               │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │  site_settings (SMTP Configuration Storage)                         │   │
│  ├──────────────────────────────────────────────────────────────────────┤   │
│  │                                                                      │   │
│  │ • email_smtp_host                                                   │   │
│  │ • email_smtp_port                                                   │   │
│  │ • email_smtp_user                                                   │   │
│  │ • email_smtp_pass                                                   │   │
│  │ • email_smtp_secure (tls/ssl/none)                                  │   │
│  │ • email_from_email                                                  │   │
│  │ • email_from_name                                                   │   │
│  │ • email_reply_to                                                    │   │
│  │                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘

================================================================================
DATA FLOW DIAGRAM
================================================================================

1. INCOMING EMAIL FLOW:
   ┌──────────────┐
   │ External     │
   │ Email Source │
   └──────┬───────┘
          │
          ↓
   ┌──────────────────────┐
   │ Email Received       │
   │ (Contact Form, etc)  │
   └──────┬───────────────┘
          │
          ↓
   ┌──────────────────────┐
   │ Create Thread        │
   │ in email_threads     │
   └──────┬───────────────┘
          │
          ↓
   ┌──────────────────────┐
   │ Admin Notified       │
   │ (Dashboard Update)   │
   └──────────────────────┘

2. REPLY FLOW:
   ┌──────────────┐
   │ Admin Types  │
   │ Reply        │
   └──────┬───────┘
          │
          ↓
   ┌──────────────────────┐
   │ Select Template      │
   │ (Optional)           │
   └──────┬───────────────┘
          │
          ↓
   ┌──────────────────────┐
   │ Create Response      │
   │ in email_responses   │
   └──────┬───────────────┘
          │
          ↓
   ┌──────────────────────┐
   │ Send Email via SMTP  │
   │ (EmailManager)       │
   └──────┬───────────────┘
          │
          ↓
   ┌──────────────────────┐
   │ Update Thread        │
   │ (response_count++)   │
   └──────────────────────┘

3. TEMPLATE FLOW:
   ┌──────────────┐
   │ Admin Creates│
   │ Template     │
   └──────┬───────┘
          │
          ↓
   ┌──────────────────────┐
   │ Store in             │
   │ email_templates      │
   └──────┬───────────────┘
          │
          ↓
   ┌──────────────────────┐
   │ Use in Reply          │
   │ (Auto-populate)      │
   └──────┬───────────────┘
          │
          ↓
   ┌──────────────────────┐
   │ Replace Variables    │
   │ ({{name}}, etc)      │
   └──────┬───────────────┘
          │
          ↓
   ┌──────────────────────┐
   │ Send Reply           │
   │ to Customer          │
   └──────────────────────┘

================================================================================
COMPONENT INTERACTION DIAGRAM
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  View (HTML/JS)                                                             │
│  ├─ dashboard.php                                                           │
│  ├─ threads.php                                                             │
│  ├─ thread-detail.php                                                       │
│  ├─ templates.php                                                           │
│  └─ settings.php                                                            │
│         │                                                                   │
│         ↓ (HTTP Request)                                                    │
│                                                                              │
│  Router (app/routes.php)                                                    │
│  ├─ Matches URL pattern                                                     │
│  ├─ Checks middleware (auth, admin)                                         │
│  └─ Dispatches to controller method                                         │
│         │                                                                   │
│         ↓ (Method Call)                                                     │
│                                                                              │
│  Controller (EmailManagerController)                                        │
│  ├─ Validates input                                                         │
│  ├─ Calls model methods                                                     │
│  ├─ Calls service methods                                                   │
│  └─ Returns view or JSON                                                    │
│         │                                                                   │
│         ├─→ Model (EmailThread, EmailTemplate, EmailResponse)               │
│         │   ├─ Query database                                               │
│         │   ├─ Validate data                                                │
│         │   └─ Return results                                               │
│         │                                                                   │
│         └─→ Service (EmailManager, EmailService)                            │
│             ├─ Load SMTP settings                                           │
│             ├─ Send emails                                                  │
│             ├─ Process templates                                            │
│             └─ Handle errors                                                │
│         │                                                                   │
│         ↓ (Response)                                                        │
│                                                                              │
│  View (Rendered HTML) or JSON Response                                      │
│  ├─ Display data                                                            │
│  ├─ Show forms                                                              │
│  └─ Handle user interactions                                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

================================================================================
SECURITY FLOW DIAGRAM
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  User Request                                                               │
│         │                                                                   │
│         ↓                                                                   │
│  ┌──────────────────┐                                                       │
│  │ Authentication   │ ← Check if user is logged in                          │
│  │ Middleware       │                                                       │
│  └──────┬───────────┘                                                       │
│         │ (Pass/Fail)                                                       │
│         ↓                                                                   │
│  ┌──────────────────┐                                                       │
│  │ Authorization    │ ← Check if user is admin                              │
│  │ Middleware       │                                                       │
│  └──────┬───────────┘                                                       │
│         │ (Pass/Fail)                                                       │
│         ↓                                                                   │
│  ┌──────────────────┐                                                       │
│  │ CSRF Token       │ ← Verify CSRF token on POST/PUT/DELETE                │
│  │ Validation       │                                                       │
│  └──────┬───────────┘                                                       │
│         │ (Pass/Fail)                                                       │
│         ↓                                                                   │
│  ┌──────────────────┐                                                       │
│  │ Input Validation │ ← Validate and sanitize input                         │
│  │ & Sanitization   │                                                       │
│  └──────┬───────────┘                                                       │
│         │ (Pass/Fail)                                                       │
│         ↓                                                                   │
│  ┌──────────────────┐                                                       │
│  │ SQL Injection    │ ← Use prepared statements                             │
│  │ Prevention       │                                                       │
│  └──────┬───────────┘                                                       │
│         │ (Pass/Fail)                                                       │
│         ↓                                                                   │
│  ┌──────────────────┐                                                       │
│  │ XSS Protection   │ ← HTML escape output                                   │
│  │                  │                                                       │
│  └──────┬───────────┘                                                       │
│         │ (Pass/Fail)                                                       │
│         ↓                                                                   │
│  ┌──────────────────┐                                                       │
│  │ Process Request  │ ← Execute business logic                              │
│  │                  │                                                       │
│  └──────┬───────────┘                                                       │
│         │                                                                   │
│         ↓                                                                   │
│  Return Response                                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

================================================================================
PERFORMANCE OPTIMIZATION FLOW
================================================================================

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│  Database Query                                                             │
│         │                                                                   │
│         ↓                                                                   │
│  ┌──────────────────────────┐                                               │
│  │ Check Index Usage        │ ← Use indexed columns                          │
│  │ (status, priority, etc)  │                                               │
│  └──────┬───────────────────┘                                               │
│         │                                                                   │
│         ↓                                                                   │
│  ┌──────────────────────────┐                                               │
│  │ Pagination               │ ← Limit results (20 per page)                 │
│  │ (LIMIT OFFSET)           │                                               │
│  └──────┬───────────────────┘                                               │
│         │                                                                   │
│         ↓                                                                   │
│  ┌──────────────────────────┐                                               │
│  │ Lazy Loading             │ ← Load data on demand                         │
│  │ (AJAX)                   │                                               │
│  └──────┬───────────────────┘                                               │
│         │                                                                   │
│         ↓                                                                   │
│  ┌──────────────────────────┐                                               │
│  │ Caching                  │ ← Cache templates, stats                      │
│  │ (In-memory)              │                                               │
│  └──────┬───────────────────┘                                               │
│         │                                                                   │
│         ↓                                                                   │
│  ┌──────────────────────────┐                                               │
│  │ Debouncing               │ ← Debounce search (300ms)                     │
│  │ (Search/Filter)          │                                               │
│  └──────┬───────────────────┘                                               │
│         │                                                                   │
│         ↓                                                                   │
│  Return Optimized Results                                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

================================================================================
END OF ARCHITECTURE DIAGRAM
================================================================================
