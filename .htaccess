# Security: Block access to sensitive directories and files
<FilesMatch "^\.">
    Order allow,deny
    Deny from all
</FilesMatch>

# Block access to sensitive directories
RedirectMatch 403 ^/(app|config|database|includes|storage|vendor|tests)/.*$

# Block access to sensitive files
<FilesMatch "(^#.*#|\.(bak|conf|dist|fla|in[ci]|log|psd|sh|sql|sw[op])|~)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Block composer files
<FilesMatch "^(composer\.(json|lock)|\.env.*|\.git.*)$">
    Order allow,deny
    Deny from all
</FilesMatch>

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Block direct access to index.php in root (force .htaccess routing)
    RewriteCond %{THE_REQUEST} ^[A-Z]+\ /[^/]*index\.php
    RewriteRule ^index\.php$ - [F,L]
    
    # Serve existing files from public directory
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule .* - [L]
    
    # Serve existing directories from public directory
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule .* - [L]
    
    # Serve files from public/uploads directory
    RewriteRule ^uploads/(.*)$ public/uploads/$1 [L]
    
    # Serve static assets from public/assets
    RewriteRule ^assets/(.*)$ public/assets/$1 [L]
    
    # Redirect favicon.ico requests to the actual favicon
    RewriteRule ^favicon\.ico$ public/uploads/settings/favicon.png [L]
    
    # Redirect any other /public URL to clean URL
    RewriteCond %{REQUEST_URI} public
    RewriteRule ^(.*)public/?(.*)$ /$1$2 [R=301,L]
    
    # Calculator URL Routing - Check if it's a calculator slug
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !^/(admin|public|assets|uploads|modules)
    RewriteRule ^([a-zA-Z0-9\-]+)/?$ public/index.php?calculator=$1 [L,QSA]
    
    # Route all other requests through public/index.php
    RewriteRule ^(.*)$ public/index.php [L,QSA]
</IfModule>
