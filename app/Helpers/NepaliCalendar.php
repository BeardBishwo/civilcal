<?php

namespace App\Helpers;

/**
 * NepaliCalendar Helper
 * Handles conversion between A.D. (English) and B.S. (Nepali) dates.
 * Uses a lookup table for B.S. month days.
 */
class NepaliCalendar
{
    // Nepali Date data (Year => [Month days])
    // Comprehensive data from 2000 BS to 2090 BS (Common range)
    // Format: 0 index is year, 1-12 are days in months 1-12
    private static $bsData = [
        2000 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2001 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2002 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2003 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 31],
        2004 => [30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2005 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2006 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2007 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 31],
        2008 => [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 29, 31],
        2009 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2010 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2011 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 31],
        2012 => [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2013 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2014 => [31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2015 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 31],
        2016 => [31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30],
        2017 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2018 => [31, 32, 31, 32, 31, 30, 30, 29, 30, 29, 30, 30],
        2019 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2020 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2021 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2022 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30],
        2023 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2024 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2025 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2026 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2027 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2028 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2029 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2030 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2031 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2032 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2033 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2034 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2035 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2036 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2037 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2038 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2039 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2040 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2041 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2042 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2043 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2044 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2045 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2046 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2047 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2048 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2049 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2050 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2051 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2052 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2053 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2054 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2055 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2056 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2057 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2058 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2059 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2060 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2061 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2062 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2063 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2064 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2065 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2066 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2067 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2068 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2069 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2070 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2071 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2072 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2073 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2074 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2075 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2076 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2077 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2078 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2079 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2080 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2081 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2082 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2083 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2084 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2085 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2086 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30],
        2087 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31],
        2088 => [31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30],
        2089 => [31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30],
        2090 => [31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 31, 30]
    ];

    private static $nepaliMonths = [
        1 => 'Baishakh', 2 => 'Jestha', 3 => 'Ashad', 4 => 'Shrawan', 
        5 => 'Bhadra', 6 => 'Ashwin', 7 => 'Kartik', 8 => 'Mangsir', 
        9 => 'Poush', 10 => 'Magh', 11 => 'Falgun', 12 => 'Chaitra'
    ];

    private static $englishMonths = [
        1 => 'January', 2 => 'February', 3 => 'March', 4 => 'April', 
        5 => 'May', 6 => 'June', 7 => 'July', 8 => 'August', 
        9 => 'September', 10 => 'October', 11 => 'November', 12 => 'December'
    ];

    /**
     * Common reference point
     * 2000-01-01 BS = 1943-04-14 AD (approximate start of data)
     * Let's use a known anchor:
     * 2000-01-01 BS = 13 April 1943 AD
     */
    const REF_BS_YEAR = 2000;
    const REF_BS_MONTH = 1;
    const REF_BS_DAY = 1;
    
    // 2000 BS starts on 1943-04-14 AD
    const REF_AD_YEAR = 1943;
    const REF_AD_MONTH = 4;
    const REF_AD_DAY = 14;

    /**
     * Convert English Date (AD) to Nepali Date (BS)
     */
    public static function adToBs($yy, $mm, $dd)
    {
        // Calculate total days from reference AD date
        $refAd = new \DateTime(self::REF_AD_YEAR . '-' . self::REF_AD_MONTH . '-' . self::REF_AD_DAY);
        $targetAd = new \DateTime("$yy-$mm-$dd");
        
        $diff = $refAd->diff($targetAd);
        $days = $diff->days;
        
        if ($targetAd < $refAd) {
             // Backward calculation not implemented in this version
             return null; 
        }

        // Add days to BS reference
        $bsYear = self::REF_BS_YEAR;
        $bsMonth = self::REF_BS_MONTH;
        $bsDay = self::REF_BS_DAY;

        while ($days > 0) {
            $daysInMonth = self::$bsData[$bsYear][$bsMonth - 1]; // 0-indexed month data

            if ($days < $daysInMonth) {
                // Remaining days fit in current month
                $bsDay += $days;
                $days = 0;
            } else {
                // Move to next month
                $days -= $daysInMonth;
                $bsMonth++;
                if ($bsMonth > 12) {
                    $bsMonth = 1;
                    $bsYear++;
                    if (!isset(self::$bsData[$bsYear])) {
                        return ['error' => 'Date out of supported range (2000-2090 BS)'];
                    }
                }
            }
        }

        return [
            'year' => $bsYear,
            'month' => $bsMonth,
            'day' => $bsDay,
            'month_name' => self::$nepaliMonths[$bsMonth],
            'day_name' => $targetAd->format('l'), // Day of week is same
            'formatted' => "$bsYear-" . str_pad($bsMonth, 2, '0', STR_PAD_LEFT) . "-" . str_pad($bsDay, 2, '0', STR_PAD_LEFT)
        ];
    }

    /**
     * Convert Nepali Date (BS) to English Date (AD)
     */
    public static function bsToAd($yy, $mm, $dd)
    {
        $bsYear = (int)$yy;
        $bsMonth = (int)$mm;
        $bsDay = (int)$dd;

        if (!isset(self::$bsData[$bsYear])) {
             return ['error' => 'Year out of supported range (2000-2090 BS)'];
        }

        // Validation
        if ($bsMonth < 1 || $bsMonth > 12) return ['error' => 'Invalid month'];
        if ($bsDay < 1 || $bsDay > self::$bsData[$bsYear][$bsMonth-1]) return ['error' => 'Invalid day for this month'];

        // Calculate total days from reference BS date
        $totalDays = 0;
        
        // Add full years
        for ($i = self::REF_BS_YEAR; $i < $bsYear; $i++) {
            $totalDays += array_sum(self::$bsData[$i]);
        }

        // Add full months of current year
        for ($i = 1; $i < $bsMonth; $i++) {
            $totalDays += self::$bsData[$bsYear][$i-1];
        }

        // Add days
        $totalDays += ($bsDay - 1); // -1 because 1st day is 0 diff

        // Add to reference AD date
        $adDate = new \DateTime(self::REF_AD_YEAR . '-' . self::REF_AD_MONTH . '-' . self::REF_AD_DAY);
        $adDate->add(new \DateInterval("P{$totalDays}D"));

        return [
            'year' => $adDate->format('Y'),
            'month' => $adDate->format('m'),
            'day' => $adDate->format('d'),
            'month_name' => $adDate->format('F'),
            'day_name' => $adDate->format('l'),
            'formatted' => $adDate->format('Y-m-d')
        ];
    }
}
