<?php

namespace App\Services;

use App\Models\Theme;
use App\Models\ThemeLicense;
use App\Models\User;
use Carbon\Carbon;
use Exception;

/**
 * Premium Theme Manager Service
 * 
 * Handles license validation, premium theme management, and advanced features
 * 
 * @package App\Services
 * @version 1.0.0
 */
class PremiumThemeManager
{
    private $licenseValidationEndpoint = 'https://api.bishwo-calculator.com/license/validate';
    private $themeUpdateEndpoint = 'https://api.bishwo-calculator.com/theme/updates';
    private $cacheManager;
    private $database;
    
    public function __construct($database = null, $cacheManager = null)
    {
        $this->database = $database;
        $this->cacheManager = $cacheManager;
    }
    
    /**
     * Validate theme license
     * 
     * @param string $licenseKey
     * @param string $domain
     * @param string $userId
     * @return array
     */
    public function validateLicense($licenseKey, $domain = null, $userId = null)
    {
        try {
            // Check if license exists in local database
            $localLicense = $this->getLocalLicense($licenseKey);
            
            if (!$localLicense) {
                return $this->createErrorResponse('License not found in local database');
            }
            
            // Check if license is expired
            if ($this->isLicenseExpired($localLicense)) {
                return $this->createErrorResponse('License has expired');
            }
            
            // Check domain restrictions
            if ($domain && !$this->validateDomain($localLicense, $domain)) {
                return $this->createErrorResponse('License domain restriction violated');
            }
            
            // Check user restrictions
            if ($userId && !$this->validateUser($localLicense, $userId)) {
                return $this->createErrorResponse('License user restriction violated');
            }
            
            // Validate with remote server (optional)
            if ($this->shouldValidateRemotely($localLicense)) {
                $remoteValidation = $this->validateRemoteLicense($licenseKey, $domain);
                if (!$remoteValidation['valid']) {
                    return $remoteValidation;
                }
            }
            
            // Update last validation
            $this->updateLastValidation($localLicense['id']);
            
            return [
                'valid' => true,
                'license' => $localLicense,
                'features' => $this->getLicenseFeatures($localLicense),
                'expires_at' => $localLicense['expires_at']
            ];
            
        } catch (Exception $e) {
            $this->logError('License validation error: ' . $e->getMessage());
            return $this->createErrorResponse('License validation failed');
        }
    }
    
    /**
     * Install theme from ZIP
     * 
     * @param string $zipPath
     * @param string $licenseKey
     * @param string $userId
     * @return array
     */
    public function installThemeFromZip($zipPath, $licenseKey, $userId = null)
    {
        try {
            // Validate license first
            $licenseValidation = $this->validateLicense($licenseKey, $_SERVER['HTTP_HOST'] ?? '', $userId);
            
            if (!$licenseValidation['valid']) {
                return $licenseValidation;
            }
            
            // Extract ZIP file
            $extractPath = $this->extractThemeZip($zipPath);
            if (!$extractPath) {
                return $this->createErrorResponse('Failed to extract theme ZIP');
            }
            
            // Validate theme structure
            $themeValidation = $this->validateThemeStructure($extractPath);
            if (!$themeValidation['valid']) {
                return $themeValidation;
            }
            
            // Install theme
            $installResult = $this->installTheme($extractPath, $themeValidation['theme_data']);
            if (!$installResult['success']) {
                return $installResult;
            }
            
            // Update license usage
            $this->incrementLicenseUsage($licenseValidation['license']['id']);
            
            return [
                'success' => true,
                'theme' => $installResult['theme'],
                'message' => 'Theme installed successfully'
            ];
            
        } catch (Exception $e) {
            $this->logError('Theme installation error: ' . $e->getMessage());
            return $this->createErrorResponse('Theme installation failed');
        }
    }
    
    /**
     * Get theme settings
     * 
     * @param string $themeName
     * @param string $userId
     * @return array
     */
    public function getThemeSettings($themeName, $userId = null)
    {
        try {
            $theme = $this->getTheme($themeName);
            if (!$theme) {
                return $this->createErrorResponse('Theme not found');
            }
            
            $userSettings = $this->getUserThemeSettings($themeName, $userId);
            $themeSettings = $this->getDefaultThemeSettings($themeName);
            
            // Merge user settings with defaults
            $settings = array_merge($themeSettings, $userSettings);
            
            return [
                'success' => true,
                'settings' => $settings,
                'theme' => $theme
            ];
            
        } catch (Exception $e) {
            $this->logError('Get theme settings error: ' . $e->getMessage());
            return $this->createErrorResponse('Failed to get theme settings');
        }
    }
    
    /**
     * Update theme settings
     * 
     * @param string $themeName
     * @param array $settings
     * @param string $userId
     * @return array
     */
    public function updateThemeSettings($themeName, $settings, $userId = null)
    {
        try {
            // Validate settings against schema
            $validation = $this->validateSettings($themeName, $settings);
            if (!$validation['valid']) {
                return $validation;
            }
            
            // Save settings
            $result = $this->saveUserThemeSettings($themeName, $settings, $userId);
            
            if ($result) {
                return [
                    'success' => true,
                    'message' => 'Settings updated successfully'
                ];
            } else {
                return $this->createErrorResponse('Failed to save settings');
            }
            
        } catch (Exception $e) {
            $this->logError('Update theme settings error: ' . $e->getMessage());
            return $this->createErrorResponse('Failed to update settings');
        }
    }
    
    /**
     * Get available themes
     * 
     * @param string $userId
     * @return array
     */
    public function getAvailableThemes($userId = null)
    {
        try {
            $themes = $this->getInstalledThemes();
            $licensedThemes = $this->getLicensedThemes($userId);
            
            $availableThemes = [];
            foreach ($themes as $theme) {
                $isLicensed = in_array($theme['name'], $licensedThemes);
                $availableThemes[] = array_merge($theme, [
                    'licensed' => $isLicensed,
                    'user_has_access' => $isLicensed || $theme['is_free'] ?? false
                ]);
            }
            
            return [
                'success' => true,
                'themes' => $availableThemes
            ];
            
        } catch (Exception $e) {
            $this->logError('Get available themes error: ' . $e->getMessage());
            return $this->createErrorResponse('Failed to get available themes');
        }
    }
    
    /**
     * Activate theme
     * 
     * @param string $themeName
     * @param string $userId
     * @return array
     */
    public function activateTheme($themeName, $userId = null)
    {
        try {
            $theme = $this->getTheme($themeName);
            if (!$theme) {
                return $this->createErrorResponse('Theme not found');
            }
            
            // Check if user has access
            if (!$this->userHasThemeAccess($themeName, $userId)) {
                return $this->createErrorResponse('User does not have access to this theme');
            }
            
            // Set as active theme
            $this->setActiveTheme($themeName, $userId);
            
            return [
                'success' => true,
                'theme' => $theme,
                'message' => 'Theme activated successfully'
            ];
            
        } catch (Exception $e) {
            $this->logError('Activate theme error: ' . $e->getMessage());
            return $this->createErrorResponse('Failed to activate theme');
        }
    }
    
    /**
     * Get theme customization options
     * 
     * @param string $themeName
     * @return array
     */
    public function getCustomizationOptions($themeName)
    {
        try {
            $theme = $this->getTheme($themeName);
            if (!$theme) {
                return $this->createErrorResponse('Theme not found');
            }
            
            $config = $this->getThemeConfig($themeName);
            $options = [
                'colors' => $config['colors'] ?? [],
                'typography' => $config['typography'] ?? [],
                'layouts' => $config['layouts'] ?? [],
                'components' => $config['components'] ?? [],
                'animations' => $config['animations'] ?? [],
                'premium_options' => $config['premium_options'] ?? []
            ];
            
            return [
                'success' => true,
                'options' => $options
            ];
            
        } catch (Exception $e) {
            $this->logError('Get customization options error: ' . $e->getMessage());
            return $this->createErrorResponse('Failed to get customization options');
        }
    }
    
    /**
     * Check if feature is available for user
     * 
     * @param string $feature
     * @param string $userId
     * @return bool
     */
    public function hasFeature($feature, $userId = null)
    {
        try {
            $activeTheme = $this->getActiveTheme($userId);
            if (!$activeTheme) {
                return false;
            }
            
            $themeConfig = $this->getThemeConfig($activeTheme);
            $features = $themeConfig['features'] ?? [];
            
            return in_array($feature, $features);
            
        } catch (Exception $e) {
            $this->logError('Check feature error: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * Validate remote license
     * 
     * @param string $licenseKey
     * @param string $domain
     * @return array
     */
    private function validateRemoteLicense($licenseKey, $domain)
    {
        try {
            $url = $this->licenseValidationEndpoint . '?key=' . urlencode($licenseKey) . '&domain=' . urlencode($domain);
            
            $context = stream_context_create([
                'http' => [
                    'timeout' => 10,
                    'method' => 'GET'
                ]
            ]);
            
            $response = @file_get_contents($url, false, $context);
            
            if ($response === false) {
                // If remote validation fails, return success to avoid breaking local functionality
                return ['valid' => true];
            }
            
            $data = json_decode($response, true);
            if (!$data) {
                return ['valid' => true]; // Default to local validation
            }
            
            return [
                'valid' => $data['valid'] ?? false,
                'message' => $data['message'] ?? 'Remote validation failed'
            ];
            
        } catch (Exception $e) {
            $this->logError('Remote license validation error: ' . $e->getMessage());
            return ['valid' => true]; // Default to local validation
        }
    }
    
    /**
     * Log error message
     * 
     * @param string $message
     */
    private function logError($message)
    {
        error_log('[PremiumThemeManager] ' . $message);
    }
    
    /**
     * Get license features
     * 
     * @param array $license
     * @return array
     */
    private function getLicenseFeatures($license)
    {
        $features = [
            'basic_themes' => true,
            'premium_themes' => false,
            'custom_branding' => false,
            'advanced_calculators' => false,
            'white_label' => false,
            'api_access' => false,
            'priority_support' => false
        ];
        
        $plan = $license['plan'] ?? 'basic';
        
        switch ($plan) {
            case 'premium':
                $features['premium_themes'] = true;
                $features['custom_branding'] = true;
                $features['advanced_calculators'] = true;
                // Continue to pro features
            case 'pro':
                $features['white_label'] = true;
                $features['api_access'] = true;
                $features['priority_support'] = true;
                break;
        }
        
        return $features;
    }
    
    /**
     * Get local license
     * 
     * @param string $licenseKey
     * @return array|null
     */
    private function getLocalLicense($licenseKey)
    {
        if (!$this->database) {
            return null;
        }
        
        $stmt = $this->database->prepare("SELECT * FROM theme_licenses WHERE license_key = ? AND active = 1");
        $stmt->execute([$licenseKey]);
        
        return $stmt->fetch(\PDO::FETCH_ASSOC);
    }
    
    /**
     * Check if license is expired
     * 
     * @param array $license
     * @return bool
     */
    private function isLicenseExpired($license)
    {
        return Carbon::parse($license['expires_at'])->isPast();
    }
    
    /**
     * Validate domain
     * 
     * @param array $license
     * @param string $domain
     * @return bool
     */
    private function validateDomain($license, $domain)
    {
        $allowedDomains = explode(',', $license['allowed_domains'] ?? '');
        $allowedDomains = array_map('trim', $allowedDomains);
        
        return in_array($domain, $allowedDomains) || in_array('*', $allowedDomains);
    }
    
    /**
     * Validate user
     * 
     * @param array $license
     * @param string $userId
     * @return bool
     */
    private function validateUser($license, $userId)
    {
        $allowedUsers = explode(',', $license['allowed_users'] ?? '');
        $allowedUsers = array_map('trim', $allowedUsers);
        
        return in_array($userId, $allowedUsers) || in_array('*', $allowedUsers);
    }
    
    /**
     * Create error response
     * 
     * @param string $message
     * @return array
     */
    private function createErrorResponse($message)
    {
        return [
            'valid' => false,
            'success' => false,
            'message' => $message
        ];
    }
    
    /**
     * Check if should validate remotely
     * 
     * @param array $license
     * @return bool
     */
    private function shouldValidateRemotely($license)
    {
        // Validate remotely for premium licenses or if it's been too long since last validation
        $lastValidation = Carbon::parse($license['last_validated_at'] ?? $license['created_at']);
        $daysSinceValidation = $lastValidation->diffInDays(Carbon::now());
        
        return $license['plan'] === 'premium' || $daysSinceValidation > 7;
    }
    
    /**
     * Update last validation
     * 
     * @param int $licenseId
     */
    private function updateLastValidation($licenseId)
    {
        if (!$this->database) {
            return;
        }
        
        $stmt = $this->database->prepare("UPDATE theme_licenses SET last_validated_at = NOW() WHERE id = ?");
        $stmt->execute([$licenseId]);
    }
    
    /**
     * Get installed themes
     * 
     * @return array
     */
    private function getInstalledThemes()
    {
        $themesPath = dirname(__DIR__, 2) . '/themes';
        $themes = [];
        
        if (is_dir($themesPath)) {
            $directories = glob($themesPath . '/*', GLOB_ONLYDIR);
            foreach ($directories as $dir) {
                $themeName = basename($dir);
                $themeFile = $dir . '/theme.json';
                
                if (file_exists($themeFile)) {
                    $themeData = json_decode(file_get_contents($themeFile), true);
                    $themes[] = array_merge($themeData, [
                        'name' => $themeName,
                        'path' => $dir
                    ]);
                }
            }
        }
        
        return $themes;
    }
    
    /**
     * Get theme configuration
     * 
     * @param string $themeName
     * @return array
     */
    private function getThemeConfig($themeName)
    {
        $configFile = dirname(__DIR__, 2) . '/themes/' . $themeName . '/config.php';
        
        if (file_exists($configFile)) {
            return include $configFile;
        }
        
        return [];
    }
    
    /**
     * Get active theme
     * 
     * @param string $userId
     * @return string|null
     */
    private function getActiveTheme($userId)
    {
        if (!$this->database || !$userId) {
            return 'default'; // Default theme
        }
        
        $stmt = $this->database->prepare("SELECT setting_value FROM user_theme_settings WHERE user_id = ? AND setting_key = 'active_theme' ORDER BY updated_at DESC LIMIT 1");
        $stmt->execute([$userId]);
        
        $result = $stmt->fetch(\PDO::FETCH_ASSOC);
        return $result['setting_value'] ?? 'default';
    }
    
    /**
     * Set active theme
     * 
     * @param string $themeName
     * @param string $userId
     */
    private function setActiveTheme($themeName, $userId = null)
    {
        if (!$this->database) {
            return;
        }
        
        $userId = $userId ?? 'default';
        
        $stmt = $this->database->prepare("INSERT INTO user_theme_settings (user_id, setting_key, setting_value, updated_at) VALUES (?, 'active_theme', ?, NOW()) ON DUPLICATE KEY UPDATE setting_value = ?, updated_at = NOW()");
        $stmt->execute([$userId, $themeName, $themeName]);
    }
    
    /**
     * Get user theme settings
     * 
     * @param string $themeName
     * @param string $userId
     * @return array
     */
    private function getUserThemeSettings($themeName, $userId = null)
    {
        if (!$this->database) {
            return [];
        }
        
        $userId = $userId ?? 'default';
        
        $stmt = $this->database->prepare("SELECT setting_key, setting_value FROM user_theme_settings WHERE user_id = ? AND theme_name = ?");
        $stmt->execute([$userId, $themeName]);
        
        $settings = [];
        while ($row = $stmt->fetch(\PDO::FETCH_ASSOC)) {
            $settings[$row['setting_key']] = json_decode($row['setting_value'], true);
        }
        
        return $settings;
    }
    
    /**
     * Get default theme settings
     * 
     * @param string $themeName
     * @return array
     */
    private function getDefaultThemeSettings($themeName)
    {
        $config = $this->getThemeConfig($themeName);
        return $config['default_settings'] ?? [];
    }
    
    /**
     * Save user theme settings
     * 
     * @param string $themeName
     * @param array $settings
     * @param string $userId
     * @return bool
     */
    private function saveUserThemeSettings($themeName, $settings, $userId = null)
    {
        if (!$this->database) {
            return false;
        }
        
        $userId = $userId ?? 'default';
        
        try {
            $this->database->beginTransaction();
            
            foreach ($settings as $key => $value) {
                $stmt = $this->database->prepare("INSERT INTO user_theme_settings (user_id, theme_name, setting_key, setting_value, updated_at) VALUES (?, ?, ?, ?, NOW()) ON DUPLICATE KEY UPDATE setting_value = ?, updated_at = NOW()");
                $stmt->execute([$userId, $themeName, $key, json_encode($value), json_encode($value)]);
            }
            
            $this->database->commit();
            return true;
            
        } catch (Exception $e) {
            $this->database->rollBack();
            $this->logError('Save theme settings error: ' . $e->getMessage());
            return false;
        }
    }
    
    /**
     * User has theme access
     * 
     * @param string $themeName
     * @param string $userId
     * @return bool
     */
    private function userHasThemeAccess($themeName, $userId = null)
    {
        $theme = $this->getTheme($themeName);
        if (!$theme) {
            return false;
        }
        
        // Free themes are accessible to everyone
        if ($theme['is_free'] ?? false) {
            return true;
        }
        
        // Check license for premium themes
        return $this->hasFeature('premium_themes', $userId);
    }
    
    /**
     * Get theme
     * 
     * @param string $themeName
     * @return array|null
     */
    private function getTheme($themeName)
    {
        $themes = $this->getInstalledThemes();
        
        foreach ($themes as $theme) {
            if ($theme['name'] === $themeName) {
                return $theme;
            }
        }
        
        return null;
    }
    
    /**
     * Get licensed themes
     * 
     * @param string $userId
     * @return array
     */
    private function getLicensedThemes($userId = null)
    {
        if (!$this->database) {
            return [];
        }
        
        // This would be implemented based on your license system
        return [];
    }
    
    /**
     * Validate settings
     * 
     * @param string $themeName
     * @param array $settings
     * @return array
     */
    private function validateSettings($themeName, $settings)
    {
        $config = $this->getThemeConfig($themeName);
        $schema = $config['settings_schema'] ?? [];
        
        // Basic validation - you can implement more sophisticated validation
        return ['valid' => true];
    }
    
    /**
     * Extract theme ZIP
     * 
     * @param string $zipPath
     * @return string|false
     */
    private function extractThemeZip($zipPath)
    {
        $extractPath = dirname(__DIR__, 2) . '/themes/temp_' . uniqid();
        
        if (!mkdir($extractPath)) {
            return false;
        }
        
        $zip = new \ZipArchive();
        if ($zip->open($zipPath) === true) {
            $zip->extractTo($extractPath);
            $zip->close();
            return $extractPath;
        }
        
        return false;
    }
    
    /**
     * Validate theme structure
     * 
     * @param string $path
     * @return array
     */
    private function validateThemeStructure($path)
    {
        $requiredFiles = ['theme.json', 'config.php'];
        
        foreach ($requiredFiles as $file) {
            if (!file_exists($path . '/' . $file)) {
                return $this->createErrorResponse("Required file missing: {$file}");
            }
        }
        
        $themeData = json_decode(file_get_contents($path . '/theme.json'), true);
        if (!$themeData) {
            return $this->createErrorResponse('Invalid theme.json file');
        }
        
        return [
            'valid' => true,
            'theme_data' => $themeData
        ];
    }
    
    /**
     * Install theme
     * 
     * @param string $sourcePath
     * @param array $themeData
     * @return array
     */
    private function installTheme($sourcePath, $themeData)
    {
        $themeName = $themeData['name'] ?? 'unknown';
        $targetPath = dirname(__DIR__, 2) . '/themes/' . $themeName;
        
        // Remove existing theme
        if (is_dir($targetPath)) {
            $this->removeDirectory($targetPath);
        }
        
        // Move extracted theme
        if (rename($sourcePath, $targetPath)) {
            return [
                'success' => true,
                'theme' => $themeData
            ];
        } else {
            return $this->createErrorResponse('Failed to install theme');
        }
    }
    
    /**
     * Remove directory recursively
     * 
     * @param string $dir
     */
    private function removeDirectory($dir)
    {
        if (is_dir($dir)) {
            $objects = scandir($dir);
            foreach ($objects as $object) {
                if ($object != "." && $object != "..") {
                    if (is_dir($dir . "/" . $object)) {
                        $this->removeDirectory($dir . "/" . $object);
                    } else {
                        unlink($dir . "/" . $object);
                    }
                }
            }
            rmdir($dir);
        }
    }
    
    /**
     * Increment license usage
     * 
     * @param int $licenseId
     */
    private function incrementLicenseUsage($licenseId)
    {
        if (!$this->database) {
            return;
        }
        
        $stmt = $this->database->prepare("UPDATE theme_licenses SET installation_count = installation_count + 1 WHERE id = ?");
        $stmt->execute([$licenseId]);
    }
}
